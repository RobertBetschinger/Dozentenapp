<!DOCTYPE html>
<html>

<head>
    <title> Fragen hinzufügen </title>
    <link rel="stylesheet" type="text/css" href="css/style.css" />

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script type="text/javascript" charset="utf-8">
        document.addEventListener("deviceready", onDeviceReady, true);

        function onLoad() {
            document.addEventListener("deviceready", onDeviceReady, true);
        }

        function onDeviceReady() {
            // navigator.notification.alert("PhoneGap is working");
            document.addEventListener("offline", onOffline, false);
            document.addEventListener("online", onOnline, false);
        }

        function callMainMenu() {
            window.location = "index.html";
        }

        function onOffline() {
            alert("Keine Internetverbindung! App nur eingeschränkt verwendungsfähig.");
        }

        function onOnline() {
            alert("Internetverbindung wieder vorhanden.");
        }
    </script>

</head>
<style>

</style>

<body>

    <div id="nav_bar">
        <button id="nav_back_button" type="button" onclick="callMainMenu()"><img id="arrow_back" src="images/arrow_left_black.svg" alt="Back"></button>
    </div>
    <h1> Neue Frage anlegen </h1>

    <p>Hier können Sie neue Fragen anlegen.</p>
    <p>Wählen Sie zunächste eine Kategorie aus.</p>

    <select id="selectCategorys" name="selectCategorys" size="1">
    </select>
    <br>
    <br>

    <div>
        <form id="FragenForm" name="FragenForm" class="form">
            Neue Frage in dieser Kategorie eingeben:
            <br>
            <input type="text" name="FragenText">
            <br> Antwortmöglichkeit 1:
            <br>
            <input type="text" name="Antwort1">
            <input type="radio" id="wahr1" name="Wahrheit1" value="true">
            <label for="wahr1"> Wahr</label>
            <input type="radio" id="falsch1" name="Wahrheit1" value="false">
            <label for="falsch1"> Falsch</label>
            <br>
            <br /> Antwortmöglichkeit 2:
            <br>
            <input type="text" name="Antwort2">
            <input type="radio" id="wahr2" name="Wahrheit2" value="true">
            <label for="wahr2"> Wahr</label>
            <input type="radio" id="falsch2" name="Wahrheit2" value="false">
            <label for="falsch2"> Falsch</label>
            <br>
            <br /> Antwortmöglichkeit 3:
            <br>
            <input type="text" name="Antwort3">
            <input type="radio" id="wahr3" name="Wahrheit3" value="true">
            <label for="wahr3"> Wahr</label>
            <input type="radio" id="falsch3" name="Wahrheit3" value="false">
            <label for="falsch3"> Falsch</label>
            <br>
            <br/> Antwortmöglichkeit 4:
            <br>
            <input type="text" name="Antwort4">
            <input type="radio" id="wahr4" name="Wahrheit4" value="true">
            <label for="wahr4"> Wahr</label>
            <input type="radio" id="falsch4" name="Wahrheit4" value="false">
            <label for="falsch4"> Falsch</label>
            <br>
            <br />

            <input type="submit" value="Hinzufügen" onsubmit="consoleLog();" />
            <br />

        </form>
    </div>

</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script>
    function getRndInteger(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const select = document.getElementById("selectCategorys");
    const myForm = document.getElementById("FragenForm");

    function loadData() {
        $.ajax({
            type: 'GET',
            url: 'https://projektseminarlfrb.herokuapp.com/categorys',
            data: {
                "category_name": 'IT-Business',
                "subcategory_name": 'Lock-in'
            },
            dataType: 'json',
            success: function(data) {
                //let questions = JSON.stringify(data); 
                console.table(data);

                if (data == undefined || data == null || data.length == 0) {
                    alert('Es konnten keine Kategorien geladen werden, wsl. sind noch keine Kategorien vorhanden');
                    window.location.href = './test_lernen.html';
                } else {
                    var string = JSON.stringify(data)
                    var json = JSON.parse(string)
                    fillInDataInDropdown(json)
                }
            },
            error: function(result) {
                console.log(result);
                alert("Es gab einen Fehler beim Laden der Daten!");
            }

        })
    }

    function fillInDataInDropdown(json) {
        for (var i = 0; i < json.length; i++) {
            var el = document.createElement("OPTGROUP");
            el.label = json[i].category_name;
            el.value = json[i].category_id;

            for (var j = 0; j < json[i].sub_categories.length; j++) {
                if(json[i].sub_categories[j].subcategory_id!= undefined){
                
                var ellsub = document.createElement("option");
                ellsub.label = json[i].sub_categories[j].subcategory_name;
                ellsub.value = json[i].sub_categories[j].subcategory_id;              
                ellsub.text=json[i].sub_categories[j].subcategory_name;
                el.appendChild(ellsub);
                }
            }
            select.appendChild(el)
        }
    }

    myForm.addEventListener("submit", (e) => {
        e.preventDefault();
        

        var x = document.forms["FragenForm"]["FragenText"].value;
        var y = document.forms["FragenForm"]["Antwort1"].value;
        var z = document.forms["FragenForm"]["Antwort2"].value;
        var ü = document.forms["FragenForm"]["Antwort3"].value;
        var l = document.forms["FragenForm"]["Antwort4"].value;

        if (formValidation(x, y, z, ü, l)) {

            boolean = turnBackRadioButton(document.getElementsByName('Wahrheit1'));
            boolean1 = turnBackRadioButton(document.getElementsByName('Wahrheit2'));
            boolean2 = turnBackRadioButton(document.getElementsByName('Wahrheit3'));
            boolean3 = turnBackRadioButton(document.getElementsByName('Wahrheit4'));

            var subcategory_id = document.getElementById("selectCategorys").value;
             sValue = $("option:selected", select).text()
            console.log(sValue)
            var selectBox = document.getElementById("selectCategorys");
            var op = selectBox.options[selectBox.selectedIndex];
            var optgroup = op.parentNode;

            var category_id = optgroup.value
            var category_name = optgroup.label
            alert(sValue);
            alert(subcategory_id)
            sendQuestion(x, y, z, ü, l, boolean, boolean1, boolean2, boolean3, category_name, category_id, subcategory_id, sValue);
        }

        document.getElementById("FragenForm").reset();

    })

    function sendQuestion(x, y, z, ü, l, boolean, boolean1, boolean2, boolean3, category_name, category_id, subcategory_id, subcategory_name) {
        $.ajax({
            type: 'POST',
            url: 'https://projektseminarlfrb.herokuapp.com/questions',
            data: JSON.stringify({
                "question": x,
                "category_id": category_id,
                "category_name": category_name,
                "subcategory_id": subcategory_id,
                "subcategory_name": subcategory_name,
                "answer": y,
                "boolean": boolean,
                "answer1": z,
                "boolean1": boolean1,
                "answer2": ü,
                "boolean2": boolean2,
                "answer3": l,
                "boolean3": boolean3
            }),
            dataType: 'json',
            contentType: 'application/json',
            success: function() {
                alert('Die Frage wurde erfolgreich hochgeladen');
            },
            error: function(result) {
                console.log(result);
                alert("Es gab einen Fehler beim Hochladen der Frage!");
            }

        })
    }

    function formValidation(x, y, z, ü, l) {
        console.log("Test der Validation")
        if (x == "") {
            window.alert("Bitte geben sie eine Frage ein.");
            return false;
        } else if (y == "") {
            window.alert("Bitte geben sie die erste Antwortmöglichkeit ein.");
            return false;
        } else if (z == "") {

            window.alert("Bitte geben sie die zweite Antwortmöglichkeit ein.");
            return false;
        } else if (ü == "") {

            window.alert("Bitte geben sie die dritte Antwortmöglichkeit ein.");
            return false;
        } else if (l = "") {
            window.alert("Bitte geben sie die vierte Antwortmöglichkeit ein.");
            return false;
        } else if (!validateRaioButtons(document.getElementsByName('Wahrheit1'))) {
            window.alert("Bitte geben Sie an ob die Erste Frage wahr oder Falsch sein soll!");
            return false;
        } else if (!validateRaioButtons(document.getElementsByName('Wahrheit2'))) {
            window.alert("Bitte geben Sie an ob die zweite Frage wahr oder Falsch sein soll!");
            return false;
        } else if (!validateRaioButtons(document.getElementsByName('Wahrheit3'))) {
            window.alert("Bitte geben Sie an ob die dritte Frage wahr oder Falsch sein soll!");
            return false;
        } else if (!validateRaioButtons(document.getElementsByName('Wahrheit4'))) {
            window.alert("Bitte geben Sie an ob die vierte Frage wahr oder Falsch sein soll!");
            return false;
        } else {
            return true;
        }

    }

    function validateRaioButtons(radios) {
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                // alert("Selected Value = " + radios[i].value);
                return true; // checked
                break;
            }
        }
        return false;
    }

    function turnBackRadioButton(radios) {
        for (var i = 0; i < radios.length; i++) {
            if (radios[i].checked) {
                return radios[i].value;
            }
        }
    }

    loadData();
</script>

</html>